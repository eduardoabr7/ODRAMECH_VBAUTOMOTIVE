generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int               @id @default(autoincrement())
  name            String
  gender          Gender
  email           String?            @unique
  password        String?
  phone           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  addressId       Int?              @unique

  address                     Address?          @relation(fields: [addressId], references: [id])
  userCorporation             UserCorporation[]
  workOrdersCreated           WorkOrder[]       @relation("WorkOrderCreatedBy")
  workOrdersEnded             WorkOrder[]       @relation("WorkOrderEndedBy")
  workOrdersAsClient          WorkOrder[]       @relation("WorkOrderClient")
  workOrdersAsResponsible     WorkOrder[]       @relation("WorkOrderResponsible")
  appointmentCreateds         Appointment[]     @relation("UserAppointmentCreated")

  @@map("cad_user")
}

model Enterprise {
  id                Int                         @id @default(autoincrement())
  logoUrl           String?
  name              String
  email             String
  phone             String
  cnpj              String                      @unique
  addressId         Int                         @unique

  address           Address                     @relation(fields: [addressId], references: [id])
  establishments    EnterpriseEstablishment[]
  users             UserCorporation[]

  @@map("cad_enterprise")
}

model Establishment {
  id                    Int                         @id @default(autoincrement())
  logoUrl               String?
  name                  String
  email                 String?
  phone                 String
  cnpj                  String                      @unique
  addressId             Int                         @unique

  address               Address                     @relation(fields: [addressId], references: [id])
  enterpriseRelations   EnterpriseEstablishment[]
  users                 UserCorporation[]

  @@map("cad_establishment")
}

model Address {
  id            Int             @id @default(autoincrement())
  street        String
  number        String
  complement    String?
  district      String
  city          String
  zipCode       String
  country       String

  user          User?
  enterprise    Enterprise?
  establishment Establishment?

  @@map("cad_address")
}

model EnterpriseEstablishment {
  idEnterprise     Int
  idEstablishment  Int

  enterprise       Enterprise    @relation(fields: [idEnterprise], references: [id])
  establishment    Establishment @relation(fields: [idEstablishment], references: [id])

  @@id([idEnterprise, idEstablishment])
  @@map("cad_enterprise_establishment")
}

model UserCorporation {
  idUser            Int
  idEnterprise      Int
  idEstablishment   Int

  role              Role

  user              User          @relation(fields: [idUser], references: [id])
  enterprise        Enterprise    @relation(fields: [idEnterprise], references: [id])
  establishment     Establishment @relation(fields: [idEstablishment], references: [id])

  @@id([idUser, idEnterprise, idEstablishment])
  @@map("cad_user_corporation")
}

model WorkOrder {
  id                    Int           @id @default(autoincrement())
  status                OrderStatus
  dateTimeCreation      DateTime      @default(now()) @map("date_time_creation")
  dateTimeEnd           DateTime?     @db.Timestamptz(6) @map("date_time_end")
  userCreationId        Int           @map("id_user_creation")
  userEndId             Int?          @map("id_user_end")
  userResponsibleId     Int?          @map("id_user_responsible")
  clientId              Int           @map("id_client")
  numberOs              Int           @map("number_os")

  userCreation          User          @relation("WorkOrderCreatedBy", fields: [userCreationId], references: [id])

  userEnd               User?         @relation("WorkOrderEndedBy", fields: [userEndId],references: [id])

  userResponsible       User?         @relation("WorkOrderResponsible", fields: [userResponsibleId],references: [id])

  client                User          @relation("WorkOrderClient", fields: [clientId], references: [id])

  @@map("work_orders")
}

model Appointment {
  id                    Int                   @id @default(autoincrement())
  dateTime              DateTime              @db.Timestamptz(6) @map("date_time")
  contentHtml           String                @map("content_html")
  userAppointmentId     Int                   @map("id_user_appointment")
  appointpentType       TypeAppointment       @map("appointment_type")

  userAppointment       User                  @relation("UserAppointmentCreated", fields: [userAppointmentId], references: [id])

  archives              ArchiveAppointment[]

  @@map("appointments")
}

model ArchiveAppointment {
  id                    Int               @id @default(autoincrement())
  archiveId             Int               @map("id_archive")
  appointmentId         Int               @map("id_appointment")
  archiveType           Int               @map("archive_type")
  url                   String
  mimeType              String            @map("mime_type")
  createdAt             DateTime          @default(now())

  appointment           Appointment  @relation(fields: [appointmentId], references: [id])

  @@map("archive_appointment")
}

enum Role {
  ADMIN
  USER
  WORKER
}

enum OrderStatus {
  PENDENTE
  EM_ATENDIMENTO
  AGUARDANDO_PECAS
  FINALIZADA
  CANCELADA
}

enum Gender {
  M
  F
  O
}

enum TypeAppointment {
  PUBLICO
  INTERNO
}